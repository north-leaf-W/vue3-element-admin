system: 1.0.0 
info:
  name: vue3-element-admin
  vars:
    API_URL:
      description: >-
        后端API地址，如https://api.youlai.tech
    AUTH_TOKEN:
      description: >-
        访问API所需的认证令牌
envs:
  dev:
    branch: dev
  prod:
    branch: main
routes:
  main_env: prod
  main_app: frontend
auths:
  apikey:
    type: api_key
    envs:
      dev:
        in: header
        name: Authorization
        value: ${{vars.AUTH_TOKEN}}
      prod:
        in: header
        name: Authorization
        value: ${{vars.AUTH_TOKEN}}
apps:
  frontend:
    type: web_frontend
    envs:
      dev:
        build:
          root_path: .
          before_script: |
            NODE_VERSION=20
            echo "DEBUG: Running before_script for dev. Current directory: $(pwd)"
            if [ -f package.json ]; then
              echo "DEBUG: package.json found. Modifying preinstall hook..."
              cp package.json package.json.bak.fc_dev
              # Replace the preinstall script with a harmless echo command
              sed -i 's/"preinstall":[[:space:]]*"npx only-allow pnpm"/"preinstall": "echo \\"pnpm check bypassed in dev by before_script\\""/' package.json
              echo "DEBUG: package.json modification attempt complete for dev. Content after sed:"
              grep "preinstall" package.json || echo "DEBUG: 'preinstall' not found by grep after sed."
            else
              echo "DEBUG: WARNING - package.json not found in before_script for dev."
            fi
          script: pnpm install --no-frozen-lockfile; pnpm build
        provision:
          root_path: dist
          type: nodejs18x
      prod:
        build:
          root_path: .
          before_script: |
            NODE_VERSION=20
            echo "DEBUG: Running before_script for prod. Current directory: $(pwd)"
            if [ -f package.json ]; then
              echo "DEBUG: package.json found. Modifying preinstall hook..."
              cp package.json package.json.bak.fc_prod
              # Replace the preinstall script with a harmless echo command
              sed -i 's/"preinstall":[[:space:]]*"npx only-allow pnpm"/"preinstall": "echo \\"pnpm check bypassed in prod by before_script\\""/' package.json
              echo "DEBUG: package.json modification attempt complete for prod. Content after sed:"
              grep "preinstall" package.json || echo "DEBUG: 'preinstall' not found by grep after sed."
            else
              echo "DEBUG: WARNING - package.json not found in before_script for prod."
            fi
          script: pnpm install --no-frozen-lockfile; pnpm build
        provision:
          root_path: dist
          type: nodejs18x
services:
  store:
    type: kv_store
    envs:
      dev:
        auths:
          - apikey
        provision:
          type: kv_store_v1
          namespaces:
            - dailycounter
      prod:
        auths:
          - apikey
        provision:
          type: kv_store_v1
          namespaces:
            - dailycounter
            - counter2 
